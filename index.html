<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foam Induction Testing System</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .step-transition-enter-active, .step-transition-leave-active { transition: opacity 0.3s ease; }
        .step-transition-enter-from, .step-transition-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div id="app" class="max-w-4xl mx-auto">
        
        <div class="bg-white rounded-lg shadow-xl p-6 mb-4">
            <h1 class="text-3xl font-bold text-indigo-900 mb-2">Foam Concentrate Testing System</h1>
            <p class="text-gray-600 italic">Professional induction percentage calculator based on Test Kit Manual</p>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex items-center justify-between mb-2">
                <div v-for="(label, idx) in ['Setup', 'Calibration', 'Testing', 'Results']" :key="idx" class="flex items-center">
                    <div :class="[
                        'w-8 h-8 rounded-full flex items-center justify-center font-bold',
                        step > idx + 1 ? 'bg-green-500 text-white' : (step === idx + 1 ? 'bg-indigo-600 text-white' : 'bg-gray-300 text-gray-600')
                    ]">
                        {{ step > idx + 1 ? '✓' : idx + 1 }}
                    </div>
                    <span class="ml-2 text-sm font-medium hidden sm:inline">{{ label }}</span>
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-indigo-600 h-2 rounded-full transition-all duration-500" :style="{ width: (step / 4) * 100 + '%' }"></div>
            </div>
        </div>

        <div v-if="step === 1" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Step 1: System Configuration</h2>
            
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Select Foam System Type</label>
                <div class="grid grid-cols-3 gap-4">
                    <button v-for="type in ['1', '3', '6']" :key="type" @click="systemType = type"
                        :class="['p-4 border-2 rounded-lg font-semibold transition-all', systemType === type ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-gray-200 hover:border-indigo-300']">
                        {{ type }}% System
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Testing Standard</label>
                <div class="grid grid-cols-2 gap-4">
                    <button v-for="std in ['NFPA11', 'BS5306']" :key="std" @click="standard = std"
                        :class="['p-4 border-2 rounded-lg font-semibold transition-all', standard === std ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-gray-200 hover:border-indigo-300']">
                        {{ std }}
                    </button>
                </div>
            </div>

            <button @click="step = 2" :disabled="!systemType" class="w-full bg-indigo-600 text-white py-4 rounded-lg font-bold hover:bg-indigo-700 disabled:bg-gray-300 transition-all">
                Continue to Calibration
            </button>
        </div>

        <div v-if="step === 2" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Step 2: Calibration Wizard</h2>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                <p class="font-bold text-blue-900 mb-2">Prepare Standard Solutions ({{ systemType }}% System)</p>
                <ul class="list-disc list-inside space-y-2 text-sm text-blue-800">
                    <li v-for="instr in currentInstructions.instructions">{{ instr }}</li>
                </ul>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Induction Water RI (Reference Point)</label>
                <input type="number" step="0.1" v-model="testData.inductionWaterRI" class="w-full p-4 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. 4.4">
            </div>

            <button @click="step = 3" :disabled="!testData.inductionWaterRI" class="w-full bg-indigo-600 text-white py-4 rounded-lg font-bold hover:bg-indigo-700">
                Continue to Data Entry
            </button>
        </div>

        <div v-if="step === 3" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Step 3: RI Data Entry</h2>
            
            <div class="overflow-x-auto mb-6">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="p-3 text-sm font-bold text-gray-600">Sample</th>
                            <th class="p-3 text-sm font-bold text-gray-600">Conc %</th>
                            <th class="p-3 text-sm font-bold text-gray-600">RI Reading (Brix)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        <tr v-for="(conc, i) in currentInstructions.concentrations" :key="i">
                            <td class="p-3 text-sm">Standard {{ i + 1 }}</td>
                            <td class="p-3 font-mono">{{ conc }}%</td>
                            <td class="p-3">
                                <input type="number" step="0.1" v-model="testData['standard' + (i+1) + 'RI']" class="w-full p-2 border rounded">
                            </td>
                        </tr>
                        <tr class="bg-yellow-50">
                            <td class="p-3 font-bold">Produced Foam</td>
                            <td class="p-3 text-xs text-gray-500 italic">Target</td>
                            <td class="p-3">
                                <input type="number" step="0.1" v-model="testData.finishedFoamRI" class="w-full p-2 border-2 border-yellow-400 rounded font-bold">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="flex gap-4">
                <button @click="step = 2" class="flex-1 bg-gray-200 py-4 rounded-lg font-bold">Back</button>
                <button @click="calculateResults" :disabled="!isStep3Complete" class="flex-1 bg-indigo-600 text-white py-4 rounded-lg font-bold">Calculate Results</button>
            </div>
        </div>

        <div v-if="step === 4 && results" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Step 4: Analysis Results</h2>
            
            <div :class="['p-6 rounded-xl text-center mb-6', results.compliant ? 'bg-green-100 text-green-900 border-2 border-green-500' : 'bg-red-100 text-red-900 border-2 border-red-500']">
                <p class="text-sm font-bold uppercase tracking-widest">{{ results.compliant ? 'System Passed' : 'System Failed' }}</p>
                <p class="text-6xl font-black my-2">{{ results.inductionPercentage.toFixed(2) }}%</p>
                <p class="text-sm font-medium">Standard Allowed: {{ results.tolerance }}</p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-bold">Standard</p>
                    <p class="text-lg font-bold">{{ standard }}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-bold">Data Reliability (R²)</p>
                    <p :class="['text-lg font-bold', results.regression.r2 > 0.98 ? 'text-green-600' : 'text-orange-600']">
                        {{ (results.regression.r2 * 100).toFixed(2) }}%
                    </p>
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <button @click="generateReport" class="w-full bg-green-600 text-white py-4 rounded-lg font-bold hover:bg-green-700">Download Text Report</button>
                <button @click="resetApp" class="w-full bg-gray-600 text-white py-4 rounded-lg font-bold">Start New Test</button>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    step: 1,
                    systemType: '',
                    standard: 'NFPA11',
                    testData: {
                        inductionWaterRI: '',
                        standard1RI: '',
                        standard2RI: '',
                        standard3RI: '',
                        finishedFoamRI: ''
                    },
                    results: null,
                    calibrationInstructions: {
                        '1': {
                            concentrations: [0.5, 1.0, 1.5],
                            instructions: [
                                'Prepare 0.5% solution (extract 0.5ml replace with 0.5ml concentrate)',
                                'Prepare 1.0% solution (extract 1.0ml replace with 1.0ml concentrate)',
                                'Prepare 1.5% solution (extract 1.5ml replace with 1.5ml concentrate)'
                            ]
                        },
                        '3': {
                            concentrations: [1.0, 3.0, 5.0],
                            instructions: [
                                'Prepare 1.0% solution (extract 1.0ml replace with 1.0ml concentrate)',
                                'Prepare 3.0% solution (extract 3.0ml replace with 3.0ml concentrate)',
                                'Prepare 5.0% solution (extract 5.0ml replace with 5.0ml concentrate)'
                            ]
                        },
                        '6': {
                            concentrations: [3.0, 6.0, 7.0],
                            instructions: [
                                'Prepare 3.0% solution (extract 3.0ml replace with 3.0ml concentrate)',
                                'Prepare 6.0% solution (extract 6.0ml replace with 6.0ml concentrate)',
                                'Prepare 7.0% solution (extract 7.0ml replace with 7.0ml concentrate)'
                            ]
                        }
                    }
                }
            },
            computed: {
                currentInstructions() {
                    return this.systemType ? this.calibrationInstructions[this.systemType] : { concentrations: [], instructions: [] };
                },
                isStep3Complete() {
                    return this.testData.standard1RI && this.testData.standard2RI && this.testData.standard3RI && this.testData.finishedFoamRI;
                }
            },
            methods: {
                calculateLinearRegression(x, y) {
                    const n = x.length;
                    const sumX = x.reduce((a, b) => a + b, 0);
                    const sumY = y.reduce((a, b) => a + b, 0);
                    const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
                    const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
                    const m = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                    const c = (sumY - m * sumX) / n;
                    const yMean = sumY / n;
                    const ssTotal = y.reduce((sum, yi) => sum + Math.pow(yi - yMean, 2), 0);
                    const ssResidual = y.reduce((sum, yi, i) => sum + Math.pow(yi - (m * x[i] + c), 2), 0);
                    return { m, c, r2: 1 - (ssResidual / ssTotal) };
                },
                calculateResults() {
                    const concentrations = [0, ...this.currentInstructions.concentrations];
                    const riValues = [
                        parseFloat(this.testData.inductionWaterRI),
                        parseFloat(this.testData.standard1RI),
                        parseFloat(this.testData.standard2RI),
                        parseFloat(this.testData.standard3RI)
                    ];
                    
                    // The manual maps RI (x) to Concentration (y)
                    const regression = this.calculateLinearRegression(riValues, concentrations);
                    const inductionPercentage = regression.m * parseFloat(this.testData.finishedFoamRI) + regression.c;
                    const nominal = parseFloat(this.systemType);
                    
                    let compliant = false;
                    let tolerance = '';
                    
                    if (this.standard === 'NFPA11') {
                        const low = nominal;
                        const high = nominal === 1 ? 1.3 : (nominal === 3 ? 3.9 : 7.0);
                        tolerance = `${low}% - ${high}%`;
                        compliant = inductionPercentage >= low && inductionPercentage <= high;
                    } else {
                        const low = nominal === 6 ? 5.0 : nominal;
                        const high = nominal === 1 ? 1.25 : (nominal === 3 ? 4.0 : 6.0);
                        tolerance = `${low}% - ${high}%`;
                        compliant = inductionPercentage >= low && inductionPercentage <= high;
                    }

                    this.results = { regression, inductionPercentage, compliant, tolerance, timestamp: new Date().toLocaleString() };
                    this.step = 4;
                },
                generateReport() {
                    const report = `FOAM TEST REPORT\n================\nDate: ${this.results.timestamp}\nSystem: ${this.systemType}%\nResult: ${this.results.inductionPercentage.toFixed(2)}%\nVerdict: ${this.results.compliant ? 'PASS' : 'FAIL'}\nLinearity (R2): ${this.results.regression.r2.toFixed(4)}`;
                    const blob = new Blob([report], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `FoamReport-${new Date().toISOString().split('T')[0]}.txt`;
                    a.click();
                },
                resetApp() {
                    this.step = 1;
                    this.testData = { inductionWaterRI: '', standard1RI: '', standard2RI: '', standard3RI: '', finishedFoamRI: '' };
                    this.results = null;
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
